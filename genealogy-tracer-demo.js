// genealogy-tracer-demo.js
// This file contains the bookmarklet code for the Genealogy Tracer.
// The actual Cloudflare Worker code is located in: trace-worker/red-heart-d66e/src/index.ts
//
// To use the bookmarklet:
// 1. Ensure your Cloudflare Worker (red-heart-d66e) is deployed.
// 2. Create a new bookmark in your browser.
// 3. For the bookmark's name, use something like "Genealogy Trace".
// 4. For the bookmark's URL/Location, paste the entire 'javascript:(async function...' line below.
//    Ensure it's pasted as a single line without any line breaks.
// 5. To use: Select some text on any webpage, then click the bookmark.
// =====================================================================================

javascript:(async function fetchAndDisplayGenealogy(initialTerm){let SCRIPT_NAME='GenealogyTrace';let WORKER_URL='https://red-heart-d66e.simon-kral99.workers.dev/trace';let termToTrace=initialTerm;if(typeof initialTerm==='undefined'){const selection=window.getSelection().toString().trim();if(!selection){alert('Select a term first or provide one to fetchAndDisplayGenealogy.');return}termToTrace=selection}let existingDiv=document.getElementById(SCRIPT_NAME+'_popup');if(existingDiv){existingDiv.innerHTML='';}else{existingDiv=document.createElement('div');existingDiv.id=SCRIPT_NAME+'_popup';existingDiv.style.cssText='position:fixed;top:10px;right:10px;width:400px;max-width:90vw;background:#fff;padding:12px 16px;border:1px solid #666;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.3);font:14px/1.4 sans-serif;z-index:2147483647;overflow-y:auto;max-height:calc(100vh - 40px);';document.body.appendChild(existingDiv)}existingDiv.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><strong>Trace: ${termToTrace}</strong><button id="${SCRIPT_NAME}_closeButton" style="padding:2px 6px;">X</button></div><div id="${SCRIPT_NAME}_loading">Loading...</div><div id="${SCRIPT_NAME}_contentWrapper" style="display:none;"><div id="${SCRIPT_NAME}_items"></div><div id="${SCRIPT_NAME}_critiqueWrapper" style="margin-top:10px;font-style:italic;display:none;border-top:1px dashed #ccc;padding-top:10px;"><h4>Critique:</h4><p id="${SCRIPT_NAME}_critiqueText"></p></div><div id="${SCRIPT_NAME}_questionsWrapper" style="margin-top:10px;border-top:1px dashed #ccc;padding-top:10px;display:none;"><h4>Open Questions:</h4><ul id="${SCRIPT_NAME}_questionsList" style="margin:0;padding-left:20px;"></ul></div></div><pre id="${SCRIPT_NAME}_error" style="white-space:pre-wrap;margin-top:6px;display:none;color:red;"></pre>`;document.getElementById(SCRIPT_NAME+'_closeButton').onclick=()=>{existingDiv.remove()};const loadingDiv=document.getElementById(SCRIPT_NAME+'_loading');const contentWrapper=document.getElementById(SCRIPT_NAME+'_contentWrapper');const itemsDiv=document.getElementById(SCRIPT_NAME+'_items');const critiqueWrapper=document.getElementById(SCRIPT_NAME+'_critiqueWrapper');const critiqueTextP=document.getElementById(SCRIPT_NAME+'_critiqueText');const questionsWrapper=document.getElementById(SCRIPT_NAME+'_questionsWrapper');const questionsListUl=document.getElementById(SCRIPT_NAME+'_questionsList');const errorPre=document.getElementById(SCRIPT_NAME+'_error');try{const r=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:termToTrace})});loadingDiv.style.display='none';if(!r.ok){errorPre.textContent='Fetch failed: '+r.status+' '+await r.text();errorPre.style.display='block';return}const responseData=await r.json();const {genealogy_items,critique_of_genealogy,open_questions}=responseData;contentWrapper.style.display='block';if(genealogy_items&&genealogy_items.length>0){genealogy_items.forEach(item=>{const itemP=document.createElement('p');itemP.style.margin='0 0 6px 0';const titleText=item.title?item.title.replace(/"/g,''):'Untitled';const itemLink=document.createElement('a');if(item.url&&item.url!=='#'){itemLink.href=item.url;itemLink.target='_blank';itemLink.title='Open source: '+item.url;}else{itemLink.href='#';itemLink.style.cssText='pointer-events:none;color:inherit;text-decoration:none;';}itemLink.textContent=titleText;itemP.appendChild(itemLink);itemP.appendChild(document.createTextNode(` (${item.year||'N/A'}) â€” ${item.claim||'No claim'} `));const traceLink=document.createElement('a');traceLink.href='#';traceLink.textContent='[trace]';traceLink.title='Trace: '+titleText;traceLink.style.cssText='font-size:0.8em;margin-left:5px;color:#007bff;';traceLink.onclick=e=>{e.preventDefault();e.stopPropagation();fetchAndDisplayGenealogy(titleText)};itemP.appendChild(traceLink);itemsDiv.appendChild(itemP);});}else{itemsDiv.innerHTML='<p>No genealogy items found.</p>';}if(critique_of_genealogy&&critique_of_genealogy!=='Not identified'){critiqueTextP.textContent=critique_of_genealogy;const exploreCritiqueLink=document.createElement('a');exploreCritiqueLink.href='#';exploreCritiqueLink.textContent=' [explore this critique]';exploreCritiqueLink.title='Explore: '+critique_of_genealogy;exploreCritiqueLink.style.cssText='font-size:0.9em;margin-left:5px;color:#007bff;';critiqueTextP.appendChild(exploreCritiqueLink);exploreCritiqueLink.onclick=e=>{e.preventDefault();e.stopPropagation();fetchAndDisplayGenealogy(critique_of_genealogy)};critiqueWrapper.style.display='block';}else{critiqueWrapper.style.display='none';}if(open_questions&&open_questions.length>0){open_questions.forEach(q_text=>{const q_li=document.createElement('li');q_li.appendChild(document.createTextNode(q_text+' '));const traceQuestionLink=document.createElement('a');traceQuestionLink.href='#';traceQuestionLink.textContent='[trace]';traceQuestionLink.title='Trace: '+q_text;traceQuestionLink.style.cssText='font-size:0.9em;margin-left:5px;color:#007bff;';traceQuestionLink.onclick=e=>{e.preventDefault();e.stopPropagation();fetchAndDisplayGenealogy(q_text)};q_li.appendChild(traceQuestionLink);questionsListUl.appendChild(q_li);});questionsWrapper.style.display='block';}else{questionsWrapper.style.display='none';}if(responseData.error){errorPre.textContent='Worker Error: '+responseData.error;errorPre.style.display='block';itemsDiv.style.display='none';critiqueWrapper.style.display='none';questionsWrapper.style.display='none';}}catch(err){loadingDiv.style.display='none';errorPre.textContent='JS Error: '+err.message;errorPre.style.display='block';}})(/* initial term here */);
  